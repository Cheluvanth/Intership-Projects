###### -- Generate Price Trend Reports using Window Functions

###### -- This query calculates the rolling 3-month average sale price and the

###### -- month-over-month change in average price for each region.



WITH MonthlyAvg AS (

&nbsp;   -- Step 1: Calculate the average price for each month in each region

&nbsp;   SELECT

&nbsp;       P.region,

&nbsp;       TRUNC(T.sale\_date, 'MM') AS sale\_month,  -- Oracle equivalent of DATE\_TRUNC('month', ...)

&nbsp;       ROUND(AVG(T.final\_sale\_price), 2) AS monthly\_avg\_price

&nbsp;   FROM

&nbsp;       Transactionss T

&nbsp;   JOIN

&nbsp;       Properties P ON T.property\_id = P.property\_id

&nbsp;   GROUP BY

&nbsp;       P.region, TRUNC(T.sale\_date, 'MM')  -- must repeat the expression (not alias)

)

SELECT

&nbsp;   region,

&nbsp;   sale\_month,

&nbsp;   monthly\_avg\_price,



&nbsp;   -- Window Function 1: Rolling 3-Month Average

&nbsp;   ROUND(

&nbsp;       AVG(monthly\_avg\_price) OVER (

&nbsp;           PARTITION BY region

&nbsp;           ORDER BY sale\_month

&nbsp;           ROWS BETWEEN 2 PRECEDING AND CURRENT ROW

&nbsp;       ), 2

&nbsp;   ) AS rolling\_3\_month\_avg,



&nbsp;   -- Window Function 2: Previous Monthâ€™s Average

&nbsp;   LAG(monthly\_avg\_price, 1, 0) OVER (

&nbsp;       PARTITION BY region

&nbsp;       ORDER BY sale\_month

&nbsp;   ) AS previous\_month\_avg,



&nbsp;   -- Month-over-Month Percentage Change

&nbsp;   CASE

&nbsp;       WHEN LAG(monthly\_avg\_price, 1, 0) OVER (PARTITION BY region ORDER BY sale\_month) > 0

&nbsp;       THEN ROUND(

&nbsp;           (monthly\_avg\_price - LAG(monthly\_avg\_price, 1, 0) OVER (PARTITION BY region ORDER BY sale\_month))

&nbsp;           / LAG(monthly\_avg\_price, 1, 0) OVER (PARTITION BY region ORDER BY sale\_month) \* 100,

&nbsp;           2

&nbsp;       )

&nbsp;       ELSE NULL

&nbsp;   END AS mom\_price\_change\_pct



FROM

&nbsp;   MonthlyAvg

ORDER BY

&nbsp;   region, sale\_month;



